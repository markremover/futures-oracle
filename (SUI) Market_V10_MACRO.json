{
  "name": "(SUI) Market_V10_MACRO",
  "nodes": [
    {
      "parameters": {
        "url": "http://172.17.0.1:3001/candles",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "granularity",
              "value": "3600"
            },
            {
              "name": "limit",
              "value": "300"
            },
            {
              "name": "pair",
              "value": "SUI-PERP"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        368,
        256
      ],
      "id": "3e89c5f2-10d6-4a81-a1a6-409ef0767bae",
      "name": "Historical Candles"
    },
    {
      "parameters": {
        "url": "http://172.17.0.1:3001/price",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "pair",
              "value": "SUI-PERP"
            }
          ]
        },
        "options": {
          "timeout": 60000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        528,
        256
      ],
      "id": "f1785db6-4480-4e38-a3e0-b2184e280bad",
      "name": "Current_Price",
      "retryOnFail": true,
      "maxTries": 5,
      "waitBetweenTries": 5000
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "futurec-trigger-sui",
        "options": {}
      },
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [
        1136,
        496
      ],
      "name": "Webhook"
    },
    {
      "parameters": {
        "url": "http://172.17.0.1:3001/fng",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        848,
        256
      ],
      "id": "bd9dee94-74d2-430f-8fd7-bddda4495c35",
      "name": "F&G Index"
    },
    {
      "parameters": {
        "url": "http://172.17.0.1:3001/news",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1040,
        256
      ],
      "id": "a3354ba6-2647-4a37-9572-7d61b49a2702",
      "name": "News/Sentiment"
    },
    {
      "parameters": {
        "url": "http://172.17.0.1:3001/macro",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1232,
        256
      ],
      "id": "eee64426-fbb1-4dea-9a38-cd8ea3470dcc",
      "name": "Macro Calendar"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "e62c9875-529b-4f6c-aca6-aff55fd9d7c5",
              "leftValue": "={{ $json.confidence_score }}",
              "rightValue": 74,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            },
            {
              "id": "4d72f026-ed60-434b-ba1d-18367fbc9207",
              "leftValue": "={{ $json.final_signal }}",
              "rightValue": "BUY|SELL",
              "operator": {
                "type": "string",
                "operation": "regex"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        400,
        464
      ],
      "id": "aec348e8-249b-4874-aab5-a5aae938e09f",
      "name": "Risk Filter"
    },
    {
      "parameters": {
        "jsCode": "// --- CONFIGURATION ---\nconst PERIOD = 14;\nconst ATR_MAX_THRESHOLD = 0.01; \nconst RSI_NEUTRAL_MIN = 48;\nconst RSI_NEUTRAL_MAX = 52;\n\n// --- GET DATA FROM CANDLES ---\nconst allItems = $items('Historical Candles');\nconst candleData = allItems.map(item => item.json);\n\n// --- GET ORIGINAL WEBHOOK DATA (Pass-Through) ---\n// Fix: Grab data from Webhook to ensure trend/status aren't lost in Test Mode\nlet webhookData = {};\ntry {\n    webhookData = $('Webhook').first().json;\n} catch (e) {}\n\nlet current_price = 0;\nif (Array.isArray(candleData) && candleData.length > 0) {\n    // Index 0 is the most recent candle in Coinbase API\n    const lastCandle = candleData[0]; \n    // Support both Finnhub {c:[]} and Coinbase [[t,l,h,o,c,v]] formats\n    if (Array.isArray(lastCandle)) {\n        current_price = parseFloat(lastCandle[4]); // Coinbase\n    } else {\n        current_price = parseFloat(lastCandle['c'] || 0); // Flat object fallback\n    }\n}\n\nif (current_price === 0) {\n    return [{ json: { signal_blocked: true, reason: \"Error: No price in candles\" } }];\n}\n\n// --- PARSE CANDLES FOR CALCULATION ---\n// Handle Coinbase Format [[time, low, high, open, close, vol], ...]\nconst candles = candleData.map(c => ({\n    close: Array.isArray(c) ? parseFloat(c[4]) : parseFloat(c['4'] || c.close || 0),\n    high: Array.isArray(c) ? parseFloat(c[2]) : parseFloat(c['2'] || c.high || 0),\n    low: Array.isArray(c) ? parseFloat(c[1]) : parseFloat(c['1'] || c.low || 0)\n}));\n\n// --- CALCULATION FUNCTIONS ---\nfunction calculateATR(data, p) {\n    let sum = 0;\n    for (let i = 0; i < p; i++) {\n        const c = data[i];\n        const prev = data[i+1] ? data[i+1].close : c.close;\n        sum += Math.max(c.high - c.low, Math.abs(c.high - prev), Math.abs(c.low - prev));\n    }\n    return sum / p;\n}\n\nfunction calculateRSI(data, p) {\n    let g = 0, l = 0;\n    for (let i = 0; i < p; i++) {\n        const diff = data[i].close - data[i+1].close;\n        if (diff > 0) g += diff; else l -= diff;\n    }\n    if (l === 0) return 100;\n    return 100 - (100 / (1 + ((g/p) / (l/p))));\n}\n\nconst atr_v = calculateATR(candles, PERIOD);\nconst rsi_v = calculateRSI(candles, PERIOD);\nconst atr_p = (atr_v / current_price);\n\nlet blocked = false;\nlet msg = \"OK\";\n\nif (atr_p > ATR_MAX_THRESHOLD) {\n    blocked = true;\n    msg = \"High Volatility\";\n}\nif (rsi_v >= RSI_NEUTRAL_MIN && rsi_v <= RSI_NEUTRAL_MAX) {\n    blocked = true;\n    msg += \" | RSI Neutral\";\n}\n\nreturn [{ json: {\n    ...webhookData, // <--- CRITICAL FIX: Pass through original fields (trend, etc.)\n    current_price: current_price,\n    atr_value: atr_v,\n    atr_percentage: atr_p,\n    rsi_value: rsi_v,\n    signal_blocked: blocked,\n    reason_code4: msg\n}}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1184,
        -96
      ],
      "id": "181b1eb8-0a5a-41ca-bdfe-823692ffda97",
      "name": "Code/Function (ATR/RSI Filter)"
    },
    {
      "parameters": {
        "jsCode": "const input = items[0].json;\nconst entry = parseFloat(input.current_price || 0);\nconst signal = input.final_signal || \"WAIT\";\n\n// --- SETTINGS (SUI) ---\nconst size = \"500\";\nconst riskAmount = 10;\nconst profitAmount = 20;\n\nconst move = riskAmount / parseFloat(size);\nconst pMove = profitAmount / parseFloat(size);\n\nlet sl = 0;\nlet tp = 0;\n\nif (signal === \"BUY\") {\n    sl = entry - move;\n    tp = entry + pMove;\n} else {\n    sl = entry + move;\n    tp = entry - pMove;\n}\n\nreturn [{\n    json: {\n        ...input,\n        PRODUCT_ID: \"SUI-PERP\",\n        side: signal,\n        confidence: input.confidence_score,\n        position_size: size,\n        entry_price: entry.toFixed(3),\n        sl_price: sl.toFixed(3),\n        tp_price: tp.toFixed(3)\n    }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        608,
        448
      ],
      "id": "560cbf8e-2035-4059-95a7-d4c31accbec0",
      "name": "Code/Function (Position Sizing)"
    },
    {
      "parameters": {
        "jsCode": "/* \n   SIGNAL MODE (MANUAL TRADING) - V2\n   ---------------------------------------------------\n   Goal: Format trade details for Telegram.\n   Improvements: Visual distinction for LONG vs SHORT.\n   ---------------------------------------------------\n*/\n\nconst input = items[0].json || {};\n\n// 1. EXTRACT DATA (Calculated in 'Position Sizing' node)\nconst side = input.side || \"BUY\"; // \"BUY\" or \"SELL\"\nconst entry = parseFloat(input.current_price || 0).toFixed(3);\nconst sl = parseFloat(input.sl_price || 0).toFixed(3);\nconst tp = parseFloat(input.tp_price || 0).toFixed(3);\nconst size = input.position_size; // DYNAMIC FROM PREVIOUS NODE\n\n// 2. DEFINE VISUALS\nlet title = \"\";\nlet body = \"\";\n\nif (side === \"BUY\") {\n    title = \"ðŸŸ¢ SUI LONG (BUY) SIGNAL\";\n    body = `\n    ðŸ“ˆ **DIRECTION:** LONG (Green)\n    ðŸ’° **Entry Price:** ${entry}\n    \n    ðŸ›‘ **Stop Loss:** ${sl}\n    âœ… **Take Profit:** ${tp}\n    \n    ðŸ“¦ **Size:** ${size} SUI\n    \n    âš ï¸ *Open Coinbase and Buy manually!*\n    `.trim();\n} else {\n    title = \"ðŸ”´ SUI SHORT (SELL) SIGNAL\";\n    body = `\n    ðŸ“‰ **DIRECTION:** SHORT (Red)\n    ðŸ’° **Entry Price:** ${entry}\n    \n    ðŸ›‘ **Stop Loss:** ${sl}\n    âœ… **Take Profit:** ${tp}\n    \n    ðŸ“¦ **Size:** ${size} SUI\n    \n    âš ï¸ *Open Coinbase and Sell manually!*\n    `.trim();\n}\n\n// 3. OUTPUT FOR TELEGRAM NODE\nreturn [{\n    json: {\n        ...input,\n        success: true, // Pass-through\n        status: \"MANUAL_SIGNAL\",\n        // These fields must match exactly what you use in the Telegram Node expressions:\n        message_title: title,\n        message_body: body,\n        signal_side: side\n    }\n}];\n"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        448
      ],
      "id": "9c0b38ad-aa8a-4d3f-ab59-1292b5bbd8c3",
      "name": "Code/Function (SL/TP Jobs)1"
    },
    {
      "parameters": {
        "chatId": "5687487073",
        "text": "={{$json.message_title}}  {{$json.message_body}}\n\nðŸŒ Macro: {{ $('Market Context').first().json.sentiment }}  â„¹ï¸ Confidence: {{$json.confidence_score}}%",
        "additionalFields": {
          "parse_mode": "HTML"
        }
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        1008,
        448
      ],
      "id": "e7bca21e-547a-4ae1-8134-b5e810a25198",
      "name": "Telegram (Report)",
      "webhookId": "01bcba6c-bcda-4892-998c-e67f2855e89a",
      "credentials": {
        "telegramApi": {
          "id": "ivTcOnSN0qURvGop",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Universal Parser V2\nconst aiResponse = items[0].json;\nconst livePrice = parseFloat($items(\"Code/Function (ATR/RSI Filter)\")[0].json.current_price || 0);\n\n// Ensure confidence score lands in the correct variable\nconst signal = aiResponse.signal || \"WAIT\";\n// Fix: Gemini can send 'confidence' OR 'confidence_score' - handle both\nconst conf = aiResponse.confidence || aiResponse.confidence_score || 0;\n\nreturn {\n    json: {\n        ...aiResponse,\n        final_signal: signal,\n        current_price: livePrice,\n        confidence_score: conf // Use 'conf' so Risk Filter always sees a number\n    }\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        208,
        464
      ],
      "id": "1b85b853-cb2b-4fb9-a3bb-b4a6f07964a8",
      "name": "Parser"
    },
    {
      "parameters": {
        "url": "http://172.17.0.1:3001/market-context",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1424,
        256
      ],
      "id": "e7b8c9d0-1a2b-3c4d-5e6f-7g8h9i0j1k2l",
      "name": "Market Context"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://172.17.0.1:3001/analyze",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"pair\": \"{{ $('Current_Price').first().json.pair }}\",\n  \"source\": \"{{ $('Webhook').first().json.source || 'LIVE' }}\",\n  \"trend\": \"{{ $('Code/Function (ATR/RSI Filter)').first().json.trend_direction }}\",\n  \"rsi\": \"{{ $('Code/Function (ATR/RSI Filter)').first().json.rsi_value }}\",\n  \"technical_status\": \"{{ $('Code/Function (ATR/RSI Filter)').first().json.technical_status }}\",\n  \"fng_value\": \"{{ $('F&G Index').first().json.data[0].value }}\",\n  \"fng_label\": \"{{ $('F&G Index').first().json.data[0].value_classification }}\",\n  \"macro_events\": {{ JSON.stringify($('Macro Calendar').first().json.data) }},\n  \"market_context\": {{ JSON.stringify($('Market Context').first().json) }},\n  \"api_key\": \"AIzaSyBpUDhfTE6mHe4UtXKaljde-iIeU_8yFjg\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1616,
        256
      ],
      "id": "db91055e-2f63-48d3-adbd-d553699802aa",
      "name": "HTTP Request"
    }
  ],
  "pinData": {},
  "connections": {
    "Historical Candles": {
      "main": [
        [
          {
            "node": "Current_Price",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Current_Price": {
      "main": [
        [
          {
            "node": "Code/Function (ATR/RSI Filter)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Historical Candles",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "F&G Index": {
      "main": [
        [
          {
            "node": "News/Sentiment",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "News/Sentiment": {
      "main": [
        [
          {
            "node": "Macro Calendar",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Macro Calendar": {
      "main": [
        [
          {
            "node": "Market Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Market Context": {
      "main": [
        [
          {
            "node": "HTTP Request",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Risk Filter": {
      "main": [
        [
          {
            "node": "Code/Function (Position Sizing)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code/Function (ATR/RSI Filter)": {
      "main": [
        [
          {
            "node": "F&G Index",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code/Function (Position Sizing)": {
      "main": [
        [
          {
            "node": "Code/Function (SL/TP Jobs)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code/Function (SL/TP Jobs)1": {
      "main": [
        [
          {
            "node": "Telegram (Report)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parser": {
      "main": [
        [
          {
            "node": "Risk Filter",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "main": [
        [
          {
            "node": "Parser",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1",
    "availableInMCP": false
  },
  "versionId": "cef60b52-36cf-4ddb-83b4-22b060dd9f43",
  "meta": {
    "instanceId": "339b794e03f1726cac62299fb8b8908a3e18b0ee606aaeaa368b5c0b843b6abc"
  },
  "id": "NkdQ8Da53lLq9S02",
  "tags": []
}